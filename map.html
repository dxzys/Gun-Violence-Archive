<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass Shootings (USA Map) | Gun Violence Data Hub</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            overflow: hidden;
        }

        #map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .state {
            fill: #2d2d2d;
            stroke: #444;
            stroke-width: 0.5px;
        }

        .incident-circle {
            fill-opacity: 0.7;
            cursor: pointer;
        }

        .incident-circle:hover {
            fill-opacity: 1;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
        }

        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            min-width: 200px;
        }

        .filter-controls {
            margin-top: 10px;
        }

        .filter-controls label {
            display: block;
            margin-bottom: 5px;
        }

        .filter-controls input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .filter-controls select {
            width: 100%;
            padding: 5px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 3px;
        }

        #zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .zoom-btn {
            display: block;
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid #555;
            border-radius: 3px;
            margin-bottom: 5px;
            cursor: pointer;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        #map-container svg {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 100;
        }

        #incident-canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            pointer-events: auto;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div class="loading" id="loading">Loading gun violence data...</div>
        <canvas id="incident-canvas"></canvas>
        <svg id="map"></svg>

        <div id="zoom-controls">
            <button class="zoom-btn" id="zoom-in">+</button>
            <button class="zoom-btn" id="zoom-out">-</button>
            <button class="zoom-btn" id="reset-zoom">âŒ‚</button>
        </div>

        <div class="tooltip" id="tooltip" style="display: none;"></div>
    </div>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const svg = d3.select("#map")
            .attr("width", width)
            .attr("height", height);
        
        const projection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);
        
        const path = d3.geoPath().projection(projection);
        
        const canvas = document.getElementById("incident-canvas");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        
        function resizeCanvas() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            canvas.width = Math.round(w * dpr);
            canvas.height = Math.round(h * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        resizeCanvas();

        let quadtree = null;
        
        const zoom = d3.zoom()
            .scaleExtent([0.5, 8])
            .on("zoom", (event) => {
                const { transform } = event;
                svg.selectAll("path.state").attr("transform", transform);
                
                updateDiamondsOnZoom(transform);
            });
        
        const mapContainer = d3.select("#map-container");
        mapContainer.call(zoom);
        
        const tooltip = d3.select("#tooltip");
        
        let usData, incidentsData;
        let filteredData = [];
        
        async function loadData() {
            try {
                usData = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
                
                incidentsData = await d3.csv("data/gva_master.csv", d => {
                    const parseDate = d3.timeParse("%B %d, %Y");
                    const parsedDate = parseDate(d["Incident Date"]);
                    
                    return {
                        id: d["Incident ID"],
                        date: d["Incident Date"],
                        parsedDate: parsedDate,
                        state: d.State,
                        city: d["City Or County"],
                        address: d.Address,
                        killed: +d["Victims Killed"] || 0,
                        injured: +d["Victims Injured"] || 0,
                        suspectsKilled: +d["Suspects Killed"] || 0,
                        suspectsInjured: +d["Suspects Injured"] || 0,
                        suspectsArrested: +d["Suspects Arrested"] || 0,
                        lat: +d.latitude || null,
                        lng: +d.longitude || null,
                        totalCasualties: (+d["Victims Killed"] || 0) + (+d["Victims Injured"] || 0),
                        year: parsedDate ? parsedDate.getFullYear() : null
                    };
                });
                
                filteredData = [...incidentsData];
                
                console.log(`Loaded ${incidentsData.length} valid incidents`);
                
                projPosition(incidentsData);
                
                initializeMap();
                updateVisualization();
                setupZoomControls();
                setupCanvasEvents();
                
                document.getElementById("loading").style.display = "none";
                
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById("loading").innerHTML = 
                    "Error loading data. Please check that data/gva_master.csv exists.";
            }
        }
        
        function initializeMap() {
            svg.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(usData, usData.objects.states).features)
                .enter().append("path")
                .attr("class", "state")
                .attr("d", path);
        }
        
        function projPosition(data) {
            data.forEach(d => {
                const coords = projection([d.lng, d.lat]);
                d.x = coords ? coords[0] : null;
                d.y = coords ? coords[1] : null;
            });
        }

        // Draw incidents to canvas
        function drawIncidents(transform = d3.zoomIdentity) {
            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
            ctx.save();
            
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);
            
            const baseSize = 3;
            const adjustedSize = Math.max(1, baseSize / transform.k);
            
            ctx.globalAlpha = 0.7;
            
            // Color scale based on casualty count
            const getColor = (casualties) => {
                if (casualties <= 2) return "#FFD700";
                if (casualties <= 5) return "#FFA500";
                if (casualties <= 10) return "#FF4500";
                return "#DC143C";
            };
            
            for (let i = 0; i < filteredData.length; i++) {
                const d = filteredData[i];
                if (d.x == null || d.y == null) continue;
                
                const x = d.x, y = d.y, s = adjustedSize;
                
                ctx.fillStyle = getColor(d.totalCasualties);
                ctx.beginPath();
                ctx.moveTo(x, y - s);
                ctx.lineTo(x + s, y);
                ctx.lineTo(x, y + s);
                ctx.lineTo(x - s, y);
                ctx.closePath();
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        function rebuildQuadtree() {
            quadtree = d3.quadtree()
                .x(d => d.x)
                .y(d => d.y)
                .addAll(filteredData.filter(d => d.x != null && d.y != null));
        }
        
        function setupCanvasEvents() {
            canvas.addEventListener("mousemove", (event) => {
                const transform = d3.zoomTransform(mapContainer.node());
                const rect = canvas.getBoundingClientRect();
                const mx = (event.clientX - rect.left - transform.x) / transform.k;
                const my = (event.clientY - rect.top - transform.y) / transform.k;
                
                if (!quadtree) return;
                
                const found = quadtree.find(mx, my, 6);
                if (found) {
                    tooltip.style("display", "block")
                        .html(`
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">
                                ${found.city}, ${found.state}
                            </div>
                            <div style="margin-bottom: 8px; font-size: 13px; color: #ccc;">
                                ${found.date}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Address:</strong> ${found.address}
                            </div>
                            <hr style="margin: 8px 0; border: none; border-top: 1px solid #555;">
                            <div style="display: flex; justify-content: space-between;">
                                <div><strong>Killed:</strong> ${found.killed}</div>
                                <div><strong>Injured:</strong> ${found.injured}</div>
                            </div>
                            <div style="margin-top: 4px; font-size: 11px; color: #aaa;">
                                Incident ID: ${found.id}
                            </div>
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                } else {
                    tooltip.style("display", "none");
                }
            });
            
            canvas.addEventListener("mouseout", () => {
                tooltip.style("display", "none");
            });
        }
        
        function updateVisualization() {
            filteredData = [...incidentsData];
            
            rebuildQuadtree();
            
            const transform = d3.zoomTransform(mapContainer.node());
            drawIncidents(transform);
        }
        
        function updateDiamondsOnZoom(transform) {
            drawIncidents(transform);
        }
        
        function setupZoomControls() {
            d3.select("#zoom-in").on("click", () => {
                mapContainer.transition().call(zoom.scaleBy, 1.5);
            });
            
            d3.select("#zoom-out").on("click", () => {
                mapContainer.transition().call(zoom.scaleBy, 1 / 1.5);
            });
            
            d3.select("#reset-zoom").on("click", () => {
                mapContainer.transition().call(zoom.transform, d3.zoomIdentity);
            });
        }
        
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            
            resizeCanvas();
            
            svg.attr("width", newWidth).attr("height", newHeight);
            projection.scale(1000).translate([newWidth / 2, newHeight / 2]);
            
            svg.selectAll("path.state").attr("d", path);
            
            projPosition(incidentsData);
            rebuildQuadtree();
            const transform = d3.zoomTransform(mapContainer.node());
            drawIncidents(transform);
        });
        
        loadData();
    </script>
</body>
</html>
